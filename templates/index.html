{% extends "base.html" %}

{% block title %}Dashboard - Competitor Pricing Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-speedometer2"></i>
                Pricing Dashboard
            </h1>
            <div class="text-muted">
                <small>
                    <i class="bi bi-clock"></i>
                    Monitoring {{ data|length }} competitors
                </small>
            </div>
        </div>
    </div>
</div>

{% if not data %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
            <h4>No Data Available</h4>
            <p>Click "Refresh All" to start scraping competitor pricing data.</p>
            <form method="POST" action="{{ url_for('refresh_data') }}" class="d-inline">
                <button type="submit" class="btn btn-primary btn-lg" id="start-scraping-btn">
                    <i class="bi bi-arrow-clockwise"></i>
                    Start Scraping
                </button>
            </form>
            <div id="start-progress-indicator" class="mt-3" style="display: none;">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Scraping...</span>
            </div>
        </div>
    </div>
</div>
{% else %}



<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ data|length }}</h3>
                <small>Total Competitors</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ data.values()|selectattr('success')|list|length }}</h3>
                <small>Successfully Scraped</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ data.values()|rejectattr('success')|list|length }}</h3>
                <small>Failed Scrapes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info">
            <div class="card-body text-center">
                <h3 class="mb-0">
                    {% if data.values()|list %}
                        {{ ((data.values()|list|map(attribute='last_updated')|list|max)|from_iso).strftime('%H:%M') }}
                    {% else %}
                        --:--
                    {% endif %}
                </h3>
                <small>Last Updated</small>
            </div>
        </div>
    </div>
</div>

<!-- Competitor Cards -->
<div class="row">
    {% for competitor_id, competitor_data in data.items() %}
    <div class="col-12 mb-4">
        <div class="card pricing-card h-100 {% if not competitor_data.success %}error-state{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="competitor-header">
                    <h5 class="mb-0">
                        {% if competitor_data.success %}
                            <i class="bi bi-check-circle success-indicator"></i>
                        {% else %}
                            <i class="bi bi-x-circle error-indicator"></i>
                        {% endif %}
                        {{ competitor_data.name }}
                    </h5>
                    <div class="last-updated">
                        <i class="bi bi-clock"></i>
                        {% if competitor_data.last_updated %}
                            {{ competitor_data.last_updated|from_iso|timesince }} ago
                        {% else %}
                            Never updated
                        {% endif %}
                    </div>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('refresh_single', competitor=competitor_id) }}" 
                       class="btn btn-outline-primary btn-sm refresh-btn" 
                       title="Refresh {{ competitor_data.name }}">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                    <a href="{{ competitor_data.url }}" 
                       target="_blank" 
                       class="btn btn-outline-secondary btn-sm" 
                       title="Visit {{ competitor_data.name }}">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                {% if competitor_data.success and competitor_data.pricing_data %}
                    {% set pricing = competitor_data.pricing_data %}
                    
                    <!-- Pricing Plans -->
                    {% if pricing.plans %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-tags"></i>
                                Pricing Plans ({{ pricing.currency or 'Unknown' }})
                            </h6>
                            <div class="row">
                                {% for plan in pricing.plans %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="border rounded p-3 h-100">
                                        <div class="text-center mb-2">
                                            <h6 class="mb-1">{{ plan.name }}</h6>
                                            <div class="mb-2">
                                                <span class="badge bg-primary fs-6">{{ plan.price }}</span>
                                            </div>
                                            {% if plan.description %}
                                                <small class="text-muted">{{ plan.description }}</small>
                                            {% endif %}
                                        </div>
                                        {% if plan.features %}
                                            <div class="mt-2">
                                                <small class="text-muted feature-list">
                                                    {% for feature in plan.features[:4] %}
                                                        <i class="bi bi-check2 text-success"></i> {{ feature }}<br>
                                                    {% endfor %}
                                                    {% if plan.features|length > 4 %}
                                                        <em class="text-secondary">+{{ plan.features|length - 4 }} more...</em>
                                                    {% endif %}
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Additional Info -->
                    {% if pricing.pricing_mentions %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-currency-dollar"></i>
                                Pricing Mentions
                            </h6>
                            <div class="small">
                                {% for mention in pricing.pricing_mentions[:5] %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ mention }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Raw Extract -->
                    {% if pricing.raw_text_extract %}
                        <details class="mt-2">
                            <summary class="text-muted small" style="cursor: pointer;">
                                <i class="bi bi-file-text"></i> View extracted content
                            </summary>
                            <div class="mt-2 p-2 bg-dark rounded small" style="max-height: 200px; overflow-y: auto;">
                                {{ pricing.raw_text_extract }}
                            </div>
                        </details>
                    {% endif %}
                    
                {% else %}
                    <!-- Error State -->
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle error-indicator fs-1 d-block mb-2"></i>
                        <h6 class="text-muted">Scraping Failed</h6>
                        {% if competitor_data.error %}
                            <p class="small text-danger mb-0">{{ competitor_data.error }}</p>
                        {% endif %}
                        <div class="mt-3">
                            <a href="{{ url_for('refresh_single', competitor=competitor_id) }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i>
                                Retry Scraping
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Last updated: {{ competitor_data.last_updated|from_iso|timesince }} ago
                    </small>
                    {% if competitor_data.success %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-danger">Error</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Refresh All Button -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <form method="POST" action="{{ url_for('refresh_data') }}" class="d-inline">
            <button type="submit" class="btn btn-primary btn-lg" id="refresh-all-btn">
                <i class="bi bi-arrow-clockwise"></i>
                <span id="refresh-all-text">Refresh All Data</span>
            </button>
        </form>
        <div id="progress-indicator" class="mt-3" style="display: none;">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span id="progress-text">Starting scraping...</span>
        </div>
    </div>
</div>


{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Auto-refresh functionality (optional)
function autoRefresh() {
    if (confirm('Auto-refresh will reload pricing data every 5 minutes. Continue?')) {
        setInterval(function() {
            window.location.reload();
        }, 5 * 60 * 1000); // 5 minutes
    }
}

// Add some interactivity to pricing cards
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to competitor cards
    const cards = document.querySelectorAll('.pricing-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.boxShadow = '';
        });
    });

    // Handle refresh all button
    const refreshAllBtn = document.getElementById('refresh-all-btn');
    const progressIndicator = document.getElementById('progress-indicator');
    const progressText = document.getElementById('progress-text');
    
    if (refreshAllBtn) {
        refreshAllBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // Show progress indicator
            progressIndicator.style.display = 'block';
            refreshAllBtn.disabled = true;
            refreshAllBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Scraping...</span>';

            const competitors = ['Carta', 'Bolago', 'NVR', 'Ledgy', 'Cake Equity', 'Mantle'];
            let currentIndex = 0;
            let progressActive = true;

            function updateProgress() {
                if (!progressActive) return;
                if (currentIndex < competitors.length) {
                    progressText.textContent = `Scraping ${competitors[currentIndex]}...`;
                    currentIndex++;
                    setTimeout(updateProgress, 3000);
                } else {
                    progressText.textContent = 'Finalizing results...';
                }
            }

            updateProgress();

            // Use fetch to POST instead of submitting the form directly
            fetch(refreshAllBtn.closest('form').action, { method: 'POST' })
                .then(() => {
                    progressActive = false;
                    progressText.textContent = 'Finalizing results...';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch(() => {
                    progressActive = false;
                    progressText.textContent = 'Failed to refresh. Please try again.';
                    refreshAllBtn.disabled = false;
                    refreshAllBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span id="refresh-all-text">Refresh All Data</span>';
                });
        });
    }

    // Handle start scraping button
    const startScrapingBtn = document.getElementById('start-scraping-btn');
    const startProgressIndicator = document.getElementById('start-progress-indicator');
    if (startScrapingBtn && startProgressIndicator) {
        startScrapingBtn.addEventListener('click', function(e) {
            e.preventDefault();

            startProgressIndicator.style.display = 'inline-flex';
            startScrapingBtn.disabled = true;
            startScrapingBtn.innerHTML = '<div class="spinner-border spinner-border-sm text-light me-2" role="status"><span class="visually-hidden">Loading...</span></div> Scraping...';

            fetch(startScrapingBtn.closest('form').action, { method: 'POST' })
                .then(() => {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch(() => {
                    startProgressIndicator.style.display = 'none';
                    startScrapingBtn.disabled = false;
                    startScrapingBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Start Scraping';
                });
        });
    }
});

// Custom filter functions for Jinja2 templates
function fromIso(dateString) {
    return new Date(dateString);
}

function timeSince(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return diffMins + ' minute' + (diffMins !== 1 ? 's' : '');
    if (diffHours < 24) return diffHours + ' hour' + (diffHours !== 1 ? 's' : '');
    return diffDays + ' day' + (diffDays !== 1 ? 's' : '');
}
</script>

{% endblock %}
